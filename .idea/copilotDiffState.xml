<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/mrp/handler/MediaHandler.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/mrp/handler/MediaHandler.java" />
              <option name="originalContent" value="package mrp.handler;&#10;&#10;import com.sun.net.httpserver.HttpExchange;&#10;import com.sun.net.httpserver.HttpHandler;&#10;import mrp.service.MediaService;&#10;&#10;import java.io.IOException;&#10;&#10;public class MediaHandler implements HttpHandler {&#10;    private MediaService mediaService = new MediaService();&#10;&#10;    @Override&#10;    public void handle(HttpExchange exchange) throws IOException {&#10;        String method = exchange.getRequestMethod();&#10;        String path = exchange.getRequestURI().getPath();&#10;&#10;        try {&#10;            // Check authentication for all media endpoints except possibly public ones&#10;            if (!mediaService.isAuthenticated(exchange)) {&#10;                sendError(exchange, 401, &quot;Unauthorized&quot;);&#10;                return;&#10;            }&#10;&#10;            switch (method) {&#10;                case &quot;POST&quot;:&#10;                    mediaService.createMedia(exchange);&#10;                    break;&#10;                case &quot;GET&quot;:&#10;                    if (path.matches(&quot;/api/media/[^/]+&quot;)) {&#10;                        mediaService.getMedia(exchange);&#10;                    } else {&#10;                        mediaService.getAllMedia(exchange);&#10;                    }&#10;                    break;&#10;                case &quot;PUT&quot;:&#10;                    mediaService.updateMedia(exchange);&#10;                    break;&#10;                case &quot;DELETE&quot;:&#10;                    mediaService.deleteMedia(exchange);&#10;                    break;&#10;                default:&#10;                    sendError(exchange, 405, &quot;Method not allowed&quot;);&#10;            }&#10;        } catch (Exception e) {&#10;            sendError(exchange, 500, &quot;Internal server error&quot;);&#10;        }&#10;    }&#10;&#10;    private void sendError(HttpExchange exchange, int code, String message) throws IOException {&#10;        exchange.sendResponseHeaders(code, message.length());&#10;        exchange.getResponseBody().write(message.getBytes());&#10;        exchange.getResponseBody().close();&#10;    }&#10;}" />
              <option name="updatedContent" value="package mrp.handler;&#10;&#10;import com.sun.net.httpserver.HttpExchange;&#10;import com.sun.net.httpserver.HttpHandler;&#10;import mrp.model.MediaEntry;&#10;import mrp.service.AuthService;&#10;import mrp.service.MediaService;&#10;import mrp.service.ServiceResult;&#10;import mrp.util.JsonUtil;&#10;&#10;import java.io.IOException;&#10;import java.io.OutputStream;&#10;&#10;public class MediaHandler implements HttpHandler {&#10;    private final MediaService mediaService;&#10;    private final AuthService authService;&#10;&#10;    public MediaHandler(MediaService mediaService, AuthService authService) {&#10;        this.mediaService = mediaService;&#10;        this.authService = authService;&#10;    }&#10;&#10;    @Override&#10;    public void handle(HttpExchange exchange) throws IOException {&#10;        String method = exchange.getRequestMethod();&#10;        String path = exchange.getRequestURI().getPath();&#10;&#10;        try {&#10;            // Authenticate all media endpoints&#10;            if (!authService.isAuthenticated(exchange)) {&#10;                sendSimpleError(exchange, 401, &quot;Unauthorized&quot;);&#10;                return;&#10;            }&#10;&#10;            String username = authService.getUsernameFromToken(exchange);&#10;            if (username == null) {&#10;                sendSimpleError(exchange, 401, &quot;Unauthorized&quot;);&#10;                return;&#10;            }&#10;&#10;            if (&quot;POST&quot;.equals(method)) {&#10;                String body = new String(exchange.getRequestBody().readAllBytes());&#10;                MediaEntry media = JsonUtil.fromJson(body, MediaEntry.class);&#10;                ServiceResult result = mediaService.createMedia(media, username);&#10;                sendServiceResult(exchange, result);&#10;                return;&#10;            }&#10;&#10;            if (&quot;GET&quot;.equals(method)) {&#10;                if (path.matches(&quot;/api/media/[^/]+&quot;)) {&#10;                    String mediaId = path.substring(path.lastIndexOf('/') + 1);&#10;                    ServiceResult result = mediaService.getMedia(mediaId);&#10;                    sendServiceResult(exchange, result);&#10;                } else {&#10;                    ServiceResult result = mediaService.getAllMedia();&#10;                    sendServiceResult(exchange, result);&#10;                }&#10;                return;&#10;            }&#10;&#10;            if (&quot;PUT&quot;.equals(method)) {&#10;                String mediaId = path.substring(path.lastIndexOf('/') + 1);&#10;                String body = new String(exchange.getRequestBody().readAllBytes());&#10;                MediaEntry updateData = JsonUtil.fromJson(body, MediaEntry.class);&#10;                ServiceResult result = mediaService.updateMedia(mediaId, updateData);&#10;                sendServiceResult(exchange, result);&#10;                return;&#10;            }&#10;&#10;            if (&quot;DELETE&quot;.equals(method)) {&#10;                String mediaId = path.substring(path.lastIndexOf('/') + 1);&#10;                ServiceResult result = mediaService.deleteMedia(mediaId);&#10;                sendServiceResult(exchange, result);&#10;                return;&#10;            }&#10;&#10;            sendSimpleError(exchange, 405, &quot;Method not allowed&quot;);&#10;        } catch (Exception e) {&#10;            sendSimpleError(exchange, 500, &quot;Internal server error&quot;);&#10;        }&#10;    }&#10;&#10;    private void sendServiceResult(HttpExchange exchange, ServiceResult result) throws IOException {&#10;        String body = result.getBody() == null ? &quot;&quot; : result.getBody();&#10;        exchange.getResponseHeaders().add(&quot;Content-Type&quot;, &quot;application/json&quot;);&#10;        exchange.sendResponseHeaders(result.getStatusCode(), body.getBytes().length);&#10;        try (OutputStream os = exchange.getResponseBody()) {&#10;            os.write(body.getBytes());&#10;        }&#10;    }&#10;&#10;    private void sendSimpleError(HttpExchange exchange, int code, String message) throws IOException {&#10;        exchange.sendResponseHeaders(code, message.length());&#10;        try (OutputStream os = exchange.getResponseBody()) {&#10;            os.write(message.getBytes());&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/java/mrp/service/ServiceResult.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/mrp/service/ServiceResult.java" />
              <option name="updatedContent" value="package mrp.service;&#10;&#10;public class ServiceResult {&#10;    private final int statusCode;&#10;    private final String body;&#10;&#10;    public ServiceResult(int statusCode, String body) {&#10;        this.statusCode = statusCode;&#10;        this.body = body;&#10;    }&#10;&#10;    public int getStatusCode() {&#10;        return statusCode;&#10;    }&#10;&#10;    public String getBody() {&#10;        return body;&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>